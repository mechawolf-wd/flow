import { isPrimitive } from '../utils/isPrimitive.js'

export function generateNewReference(type) {
    function getRandomNumberString(digits) {
        const min = Math.pow(10, digits - 1)
        const number = Math.trunc(Math.random() * 9 * min) + min
        return number.toString()
    }

    const part1 = getRandomNumberString(8)
    const part2 = getRandomNumberString(8)

    return `vind-rv-${type}-id-${part1}-${part2}`
}

const runComputedDependencesExtractor = (callback, variableReference) => {
    $VindEngine.computedDependencyExtractorRunning = true
    $VindEngine.currentReactiveVariableReference = variableReference

    callback()

    $VindEngine.computedDependencyExtractorRunning = false
    $VindEngine.currentReactiveVariableReference = ''
    $VindEngine.extractedComputedDependencies = new Set()
}

const getReactiveVariableType = (configuration) => {
    let type = ''

    if (configuration.isRef) {
        type = 'ref'
    } else if (configuration.isComputed) {
        type = 'computed'
    } else if (configuration.isProp) {
        type = 'prop'
    } else {
        type = 'unspecified'
    }

    return type
}

const isValueAnActualObject = (value) => {
    return value !== null && Object.prototype.toString.call(value) === '[object Object]';
};

const getReactiveVariable = (value, configuration) => {
    if (!isValueAnActualObject(value)) return value

    const outputReactiveObject = {};

    for (const key in value) {
        const condition = isValueAnActualObject(value[key])

        outputReactiveObject[key] = condition ? reactiveVariable(value[key], configuration) : value[key];
    }

    return outputReactiveObject;
};

export const reactiveVariable = (value, configuration = {}) => {
    configuration.isReactiveVariable = true

    let type = getReactiveVariableType(configuration)

    const variableReference = generateNewReference(type)

    $VindEngine.watchCallbacks[variableReference] ??= []

    if (configuration.isComputed) {
        runComputedDependencesExtractor(value, variableReference, configuration)
    }

    configuration.isValueAnActualObject = isValueAnActualObject(value)
    configuration.isValuePrimitive = isPrimitive(value)

    const variableProxy = new Proxy(
        {
            ...(configuration.isValueAnActualObject ? getReactiveVariable(value, configuration) : { value })
        },
        {
            get(target, property) {
                if ($VindEngine.computedDependencyExtractorRunning) {
                    $VindEngine.extractedComputedDependencies.add(variableReference)
                    configuration.influences.push($VindEngine.currentReactiveVariableReference)

                    return
                }

                if ($VindEngine.dependencyExtractorRunning) {
                    $VindEngine.extractedDependencies.add(variableReference)
                }

                const propertyValue = target[property]

                return typeof propertyValue === 'function' ? propertyValue() : propertyValue
            },

            set(target, property, newValue) {
                const previousValue = target[property]

                if (configuration.isValuePrimitive && newValue === previousValue) {
                    return true
                }

                target[property] = newValue

                const watchCallbacks = $VindEngine.watchCallbacks[variableReference]

                if (watchCallbacks.length > 0) {
                    watchCallbacks.forEach(watchSignal => watchSignal(newValue, previousValue))
                }

                const influencedReferences = configuration.influences

                influencedReferences.forEach((influencedReference) => {
                    const computedWatchCallbacks = $VindEngine.watchCallbacks[influencedReference]

                    const computedReactiveReference = $VindEngine.reactiveVariables[influencedReference].variableProxy

                    computedWatchCallbacks.forEach(watchSignal => watchSignal(computedReactiveReference.value, computedReactiveReference.value))
                })

                $VindEngine.runReactiveEffects({ reference: variableReference, configuration })

                return true
            }
        }
    )

    $VindEngine.reactiveVariables[variableReference] = { variableProxy, configuration }

    return variableProxy
}